{# Copyright 2014 The University of Edinburgh #}
{#  #}
{# Licensed under the Apache License, Version 2.0 (the "License"); #}
{# you may not use this file except in compliance with the License. #}
{# You may obtain a copy of the License at #}
{#  #}
{#     http://www.apache.org/licenses/LICENSE-2.0 #}
{#  #}
{# Unless required by applicable law or agreed to in writing, software #}
{# distributed under the License is distributed on an "AS IS" BASIS, #}
{# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. #}
{# See the License for the specific language governing permissions and #}
{# limitations under the License. #}

{% extends "base.html" %}
{% load staticfiles %}

{% block extra_head_content %}

<script>
var toolbox_dragcheck = false;
var dialog, form;
var titlog;
var	incrementalId = 1;

	function endsWith(str, suffix) {
	    return str.indexOf(suffix, str.length - suffix.length) !== -1;
	}
	
	// Add ... at the end of a long name
	function shorten_name(name, max_length) {
		var toret = name;
		if (name.length > max_length) {
			toret = name.slice(0, max_length-3) + '...';
		}
		return toret;
	}

	function place_items_to_toolbox(data) { 
		// Add PEs
		for (var i in data.pes) {
			var pe = data.pes[i];
			var url = null;
			var fqn = null;
			var impls = null;
			for (var k in pe) {
				url = k;
				fqn = pe[k];
			}
			var toks = fqn.split('.');
			var pename = toks[toks.length-1];
			var pepckg = fqn.substring(0, fqn.lastIndexOf('.'));
			var divToAdd = '<div class="toolbox_item" data-peurl="' + url + 
				'" data-pefqn="'+ fqn + '" title="(PE) ' + fqn + '">'+
				'<span class="toolbox_item_pckg">'  + pepckg + '</span> <br/>' +
			    '<span class="toolbox_item_name">' + pename + '</span> </div>';
			$('div#menu').append(divToAdd);
		}
		
		// Add functions
		for (var i in data.functions) {
			var fn = data.functions[i];
			var url = null;
			var fqn = null;
			var impls = null;
			for (var k in fn) {
				url = k;
				fqn = fn[k];
			}
			var toks = fqn.split('.');
			var fnname = toks[toks.length-1];
			var fnpckg = fqn.substring(0, fqn.lastIndexOf('.'));
			if (!endsWith(fnpckg, 'fns') && !endsWith(fnpckg, 'fns.filters')) {
				continue;
			}
			var divToAdd = '<div class="toolbox_item js-function" data-fnurl="' + url + 
				'" data-fnfqn="'+ fqn + '" title="(FN) ' + fqn + '">'+
				'<span class="toolbox_item_pckg">'  + shorten_name(fnpckg, 25) + '</span> <br/>' +
			    '<span class="toolbox_item_name">' + shorten_name(fnname, 22) + '</span> </div>';
			$('div#menu').append(divToAdd);
		}
	}
	
	function populate_toolbox() {
		 $.ajax({
		 	//dataType: "json",
		 	url: "http://localhost:8000/workspaces/{{workspace.id}}/?ls",
			cache: false
		 })
		.done(function(data) {
			 place_items_to_toolbox(data);
			 set_up_drag_drop();
			 $('.toolbox_item').mouseup(update_properties);
		 })
		.fail(function(data) {
			 console.error('failure:' + data);
		})
	}	

	function init_flow_divs() { 
		var numDivs = 1;
		for (var i=0; i<numDivs; i++) {
			var divToAdd = '<div class="square-box"> <div class="square-content"><div><span> Drag a PE here </span></div></div></div>';
			var arrow = '<div class="flow_box_arrow" id="">→</div>'
			$('div#main').append(divToAdd);
			if (i < numDivs-1) { 
				$('div#main').append(arrow);
			}
		}
	}
	
	function box_hover_action() { 
		var lnk = $(this).find('.rm-box-link-hidden');
		lnk.addClass('rm-box-link');
		lnk.removeClass('rm-box-link-hidden');
	}

	function box_hover_out_action() { 
		var lnk = $(this).find('.rm-box-link');
		lnk.addClass('rm-box-link-hidden');
		lnk.removeClass('rm-box-link');
	}
	
	function rm_box_action(event) {
		event.stopPropagation();
		var parent_box = $(this).parents('.square-box');
		var conn = $(parent_box).next();
		$(conn).hide(100, function() {$(this).remove();});
		$(parent_box).hide(100, function() {$(this).remove();});
	}
	
	function arrow_box_drop_action(event, ui) { 
		var targetDiv = $('div#over_temp_box');
		var originalDiv = ui.draggable[0];

		var kind = 'PE';
		if ( $( originalDiv ).hasClass('js-function') ) {
			kind = 'FN';
		}

		if ( kind == 'FN' ) { 
			drop_fn(event, ui, targetDiv);
		}
		else if ( kind == 'PE' ) {
			drop_pe(event, ui, targetDiv);
		}
		else { // shouldn't reach this point
			return;
		}
		
		$(targetDiv).click(update_properties);
		
		if ( kind == 'PE' ) {
			$(targetDiv).attr('data-peurl', $(ui.draggable[0]).attr('data-peurl'));
			$(targetDiv).attr('data-pefqn', $(ui.draggable[0]).attr('data-pefqn'));
		} 
		else if ( kind == 'FN' ) {
			$(targetDiv).attr('data-fnurl', $(ui.draggable[0]).attr('data-fnurl'));
			$(targetDiv).attr('data-fnfqn', $(ui.draggable[0]).attr('data-fnfqn'));
		}

		var lnk = $(targetDiv).find('.rm-box-link-hidden')
		$(lnk).click(rm_box_action);
		$(targetDiv).hover(box_hover_action, box_hover_out_action);

		$(targetDiv).addClass('square-box-filled');
		$('#over_temp_arrow').attr('id', '');
		$('#over_temp_box').attr('id', '');
		$('#over_temp_box_content').attr('id', '');
	}
	
	function over_arrow_action() {
		var next = $(this).next();
		if (! $(next).hasClass('square-box-filled')) { return; }
		var divToAdd = ' <div style="display:none;"  id="over_temp_box" class="square-box"> <div id="over_temp_box_content" class="square-content"><div><span> Drop to insert node here </span></div></div></div> <div style="display:none;" id="over_temp_arrow" class="flow_box_arrow" id="">_</div>';
		$(this).after(divToAdd);
		$('#over_temp_box').show(100);//, function() {$(this).remove()});
		$('#over_temp_arrow').show(100);//, function() {$(this).remove()});
		reiterate_droppables();
	}
	
	function out_arrow_action() {
		if ($(this).attr('id') != 'over_temp_box') {
			$('#over_temp_box').hide(100, function() {$(this).remove()});
			$('#over_temp_arrow').hide(100, function() {$(this).remove()});
		}
	}
	
	function reiterate_droppables() { 
   		$('div.square-box').droppable({
   			drop: box_drop_action,
   			greedy: true
   		});
		
		$('div.flow_box_arrow').droppable({
   			drop: arrow_box_drop_action,
			over: over_arrow_action,
			out: out_arrow_action,
			tolerance: 'pointer',
   			greedy: true
   		});
		
		$('div.arrow-over-wrapper').droppable({
			drop: function(){
				// console.log('dropped on wrapper')
			},
			over: function(){
				// console.log('left wrapper')
			},
			out: $('div.arrow-over-wrapper').remove(),
			tolerance: 'pointer',
			greedy: true
		});
	}
	
	function drop_pe(event, ui, target) { 

		var originalDiv = ui.draggable[0];
		var children =  $(originalDiv).children();
		var pckg = $(children[0]).text();
		var nm = $(children[2]).text();
		// If the element is already present in the pipeline, do nothing
		if ( ( $(target).attr('data-pefqn') == pckg + '.' + nm ) ) {
			return;
		}
		
		var divToAdd = '<div class="square-content"><div><span class="square-workflow-text"> ' +
			 	       '<span class="square-workflow-text-pckg">' + pckg + '</span><br/>' +
						'<span class="square-workflow-text-name">' + nm + '</span>' +
		               '<br/> ' +
		               '<br/><a href="#" class="rm-box-link-hidden">' +
					   'X</a> </span></div></div>';
		var dv = $.parseHTML(divToAdd);
		
		$(target).click(update_properties);
		$(target).html(dv);

		// Remove the js-function class, if present
		$(target).removeClass('js-function');

		$(target).attr('data-peurl', $(ui.draggable[0]).attr('data-peurl'));
		$(target).attr('data-pefqn', $(ui.draggable[0]).attr('data-pefqn'));
		$(target).attr('id', 'pe-' + incrementalId++);

		$(target).removeClass("js-fn-uninitialised");
		$(target).removeClass("js-fn-initialised");

		var lnk = $(target).find('.rm-box-link-hidden')
		$(lnk).click(rm_box_action);
		$(target).hover(box_hover_action, box_hover_out_action);
	}
	
	function drop_fn(event, ui, target) {
		var originalDiv = ui.draggable[0];
		var children =  $(originalDiv).children();
		var pckg = $(children[0]).text();
		var nm = $(children[2]).text();

		// If the element is already present in the pipeline, do nothing
		if ( ( $(target).attr('data-fnfqn') == pckg + '.' + nm ) ) {
			return;
		}
		
		var divToAdd = '<div class="square-content"> <div><span class="square-workflow-text"> ' +
			 	       '<span class="square-workflow-text-pckg">' + pckg + '</span><br/>' +
						'<span class="square-workflow-text-name">' + nm + '</span>' +
		               '<br/><br/>'+
					   '<a href="#" class="init-btn"> Set parameters </a> ' + 
		               '<a href="#" class="rm-box-link-hidden">' +
					   'Χ</a> </span></div></div>';
		var dv = $.parseHTML(divToAdd);

		$(target).click(update_properties);
		$(target).addClass('js-function');
		$(target).html(dv);
		$(target).attr('data-fnurl', $(ui.draggable[0]).attr('data-fnurl'));
		$(target).attr('data-fnfqn', $(ui.draggable[0]).attr('data-fnfqn'));
		$(target).attr('id', 'fn-' + incrementalId++);

		var lnk = $(target).find('.rm-box-link-hidden');
		$(lnk).click(rm_box_action);
		$(target).hover(box_hover_action, box_hover_out_action);

		var initbtn = $(target).find('.init-btn');
		$(initbtn).click(init_fn_action);

		// Retrieve the properties of the function and update the appearance of the div
		retrieve_fn_properties($(target).attr('data-fnurl'), function(data) {
			$(target).attr('data-properties', JSON.stringify(data));

			$(target).removeClass('js-fn-uninitialised');
			$(target).removeClass('js-fn-initialised');
			if (! hasBeenInitialised(target)) {
				$(target).addClass('js-fn-uninitialised');
				$(target).find('.init-btn').addClass('js-btn-not-initialised');
			}
			else {
				$(target).addClass('js-fn-initialised');
				$(target).find('.init-btn').addClass('js-btn-initialised');
			}
		});
	}

	/**
	 * By checking the default parameter values, determine whether
	 * the given pipeline_box (fn instantiation) has been initiated
	 * properly or not. Return true if it has; false otherwise.
	 * @param  {Element}  pipeline_box The function corresponding to
	 * the given box in the pipeline.
	 * @return {Boolean}              true if the function has been 
	 * initialised (i.e. every paramenter has a value); false otherwise.
	 */
	function hasBeenInitialised(pipeline_box) {
		var parameters = JSON.parse($(pipeline_box).attr('data-properties')).parameters;
		for (var i = 0; i < parameters.length; i++) {
			// Ignores parameters that are called 'stream'
			if ( parameters[i][0] != 'stream' && !isJson( null, parameters[i][2].trim() ) ) {
				return false;
			} 
		}
		return true;
	}

	/**
	 * Populate the initialisation dialogue based on the given function element
	 * @param  {Element} fn_element the element to parameterise
	 */
	function populate_dialog(fn_element) {

		// Get the parameters from the data-properties of the element
		var parameters = JSON.parse( $( fn_element ).attr('data-properties') ).parameters;
		
		var htmlToAdd = '';
		for ( var i = 0; i < parameters.length; i++ ) {
			var parName = parameters[i][0];
			// ignore parameters named 'stream'
			if ( parName == 'stream' ) { 
				continue;
			}
			var parVal = parameters[i][2].replace(/"/g, '&quot;');

			var row = '<label for="' + parName + '">' + parName + '</label>';
			row += '<input type="text" name="' + parName + '" id="' + parName + '" value="' + parVal + '" class="text ui-widget-content ui-corner-all"/>';
			// <!-- <label for="name">Name</label>
   //    <input type="text" name="name" id="name" value="Jane Smith" class="text ui-widget-content ui-corner-all"> -->
   			htmlToAdd += row;
		}

		$('span.ui-dialog-title').html($(fn_element).attr('data-fnfqn'));
		$('div#dialog-form').find('.validateTips').html('Parameters:');
		$('div#dialog-form').find('fieldset').html(htmlToAdd);
		$('div#dialog-form').attr('data-src-id', $(fn_element).attr('id'));
	}

	/**
	 * Display the initialisation dialogue for the selected function.
	 * @param  {Event} event The event that triggered the action
	 */
	function init_fn_action(event) {
		event.stopPropagation();
		var parent = $(event.target).parents('.js-function')[0];
		populate_dialog( parent );
		dialog.dialog( "open" );
	}
	
	function box_drop_action(event, ui)  {
		var kind = 'PE';
		if ( $( '#over_temp_box' ).length ) {
			return; 
		}
		
		var originalDiv = ui.draggable[0];
		if ( $( originalDiv ).hasClass('js-function') ) {
			kind = 'FN'; 
		}
		
		$(this).unbind("click");  // click events stack!

		if ( kind == 'FN' ) {
			drop_fn(event, ui, this);
		}
		else if ( kind == 'PE' ) {
			drop_pe(event, ui, this);
		}
		else { // shouldn't reach this point
			return;
		}

		if (!$(this).hasClass('square-box-filled')) {
			$(this).addClass('square-box-filled');
			var arrowDiv = '<div class="flow_box_arrow">_</div>' 
			var boxDiv = '<div class="ui-droppable square-box"> <div class="square-content"><div><span> Drag a PE here </span></div></div></div>';
			$(this).parent().append(arrowDiv);
			var dv = $.parseHTML(boxDiv);
			$(dv).droppable({drop: box_drop_action });
			$(this).parent().append(dv);
			
			reiterate_droppables();
		}
	}
	
	function update_properties_connections(urls) { 
		var toret = "<hr/><b>Connections:</b><br/>";
		for (var i in urls) {
			$.ajax({
				url: urls[i],
				cache: true
			})
			.done(function(data){
				if (data.kind == "IN") {
					$('div#properties-connections-in').append
					('• <i>' + data.name + '</i>: ' + data.comment + '<br/>');
				} 
				else if (data.kind == "OUT") {
					$('div#properties-connections-out').append
					('• <i>' + data.name + '</i>: ' + data.comment + '<br/>');
				}
			})
			.fail(function(data){
				console.error(data);
			})
		}
	}

	function init_properties_divs_pe() { 
		var s = '<div id="properties-title" ' + 
		        'style="background-color:#bbccdd; text-align:center; overflow:auto">' + 
				'</div>	' + 
					'<div id="properties-description"></div>	' + 
					'<div id="properties-connections"> ' + 
						'<div id="properties-connections-in"> ' + 
			 				'<b>Input Connections:</b><br/> ' + 
						'</div> ' + 
						'<div id="properties-connections-out"> ' + 
							'<hr/><b>Output Connections:</b><br/> ' + 
						'</div> ' + 
					'</div>';
		$('div#properties').html(s);
	}

	function update_properties_pe(event, target) {
		init_properties_divs_pe();
		var peurl = $( target ).attr('data-peurl');
		$.ajax({
			url: peurl,
			cache: true
		})
		.done(function(data) {
			$('div#properties-title').html('<b>' + data.pckg + '.' + data.name + '</b><hr/>')
			$('div#properties-description').html('<b>Description: </b> ' + data.description + '<br/><hr/>');
			update_properties_connections(data.connections);
		})
		.fail(function(data) {
			console.error('failure:' + data);
		})
	}

	function init_properties_divs_fn() {
		var s = '<div id="properties-title" ' + 
		        'style="background-color:#bbccdd; text-align:center; overflow:auto">' + 
				'</div>	' + 
					'<div id="properties-description"></div>	' + 
					'<div id="properties-parameters"> ' + 
						'<b>Parameters:</b><br/>' +  
					'</div>' +
				    '<div id="properties-return">' + 
				    	'<b>Return:</b><br/>' +
				    '</div>';
		$('div#properties').html(s);
	}

	// extract the name, parameters and return type of the given function and return
	// an object (JSON) with the details.
	function retrieve_fn_properties(fnurl, callback) {
		var ret = { pckg: '',
				    name: '',
				    description: '',
				    parameters: [],
				    rettype: {} }; 
		$.ajax({
			url: fnurl,
			cache: true
		})
		.done(function(data) {
			ret.pckg = data.pckg;
			ret.name = data.name;
			ret.rettype = data.return_type;
			ret.description = data.description;

			var param_deferred = [];
			$.each( data.parameters, function(index, paramurl) {
				param_deferred.push(
					$.ajax({
						url: paramurl,
						cache: true
					})
					.done( function(data) {
						var pname, ptype, pdefval, strtype, strdefval;
						pname = data.param_name;
						ptype = strtype = data.param_type;
						pdefval = strdefval = data.param_default_val;
						ret.parameters.push([pname, ptype, pdefval]);
					})
					.fail( function(data) {
						console.error('failure: ' + data);
					})
				);
			});
			$.when.apply($, param_deferred).done(function() {	
				callback(ret);
			});
		})
		.fail(function(data) {
			console.error('failure: ' + data);
		});
		return ret;
	}

	function init_properties_divs_fn() {
		var s = '<div id="properties-title" ' + 
		        'style="background-color:#bbccdd; text-align:center; overflow:auto">' + 
				'</div>	' + 
					'<div id="properties-description"></div>' + 
					'<div id="properties-parameters"> ' + 
						'<hr/><b>Parameters:</b><br/>' +  
					'</div>' +
				    '<div id="properties-return">' + 
				    	'<hr/><b>Return:</b><br/>' +
				    '</div>';
		$('div#properties').html(s);
	}

	function populate_fn_property_divs(fn_props) { 
		$( 'div#properties-title' ).html('<b>' + 
			fn_props.pckg + '.' + fn_props.name + 
			'</b><hr/>');
		$( 'div#properties-description' ).html('<b>Description:</b> ' + 
			fn_props.description
			);
		$.each(fn_props.parameters, function(index, value){
			var pname, ptype, pdef;
			pname = value[0];
			ptype = value[1];
			pdef = value[2];
			
			if ( !ptype || ptype.trim() == '' ) { ptype = ''; }
			if ( !pdef || pdef.trim() == '' ) { pdef = ''; }
			
			$( 'div#properties-parameters' ).append('• <i>' + pname + '</i>');
			if ( ptype != '' ) {
				$( 'div#properties-parameters' ).append(': ' + ptype);
			}
			if ( pdef != '' ) { 
				$( 'div#properties-parameters' ).append(' = ' + pdef + '');
			}
			$( 'div#properties-parameters' ).append('<br/>');
		});
	
		var rettype = fn_props.rettype;
		if ( !rettype || rettype.trim() == '' ) { 
			rettype = 'Not defined!'
		}
		$( 'div#properties-return').append(rettype);
	}
	
	function update_properties_fn(event, target) {
		init_properties_divs_fn();
		var fnurl = $(target).attr('data-fnurl');
		if ( $(target).attr('data-properties') ) { 
			populate_fn_property_divs( JSON.parse($(target).attr('data-properties')) );
		}
		else {
			retrieve_fn_properties(fnurl, populate_fn_property_divs);
		}
	}
	
	// Update the properties pane on the right-hand side of the window.
	// This is triggered on click.
	function update_properties(event) {
		$('div#properties').html('');
		var target = 0;
		if ( !$( event.target ).hasClass('toolbox_item') && 
		     !$( event.target ).hasClass('square-box-filled') ) {
			// set the target to the correct parent div
			target = $( event.target ).closest('.square-box-filled')[0];
		}
		else {
			target = event.target;
		}
		
		var kind = 'PE';
		if ( $( target ).hasClass('js-function') ) { 
			kind = 'FN';
		}
		if ( kind == 'PE' ) { 
			update_properties_pe(event, target);
		}
		else if ( kind == 'FN' ) { 
			update_properties_fn(event, target);
		}
		
	}

	/**
	 * Setup drag and drop for PEs, from the toolbox to the workflow.
	 */
	function set_up_drag_drop() {
		$(".toolbox_item").draggable({
			cursor: "move",
			stack: ".toolbox_item",
			appendTo: 'body',
			helper: 'clone',
			// containment: 'div#wrapper',
			revert: "invalid",
			drag: function() {
				toolbox_dragcheck=true;
			},
			stop: function() {
				toolbox_dragcheck = false;
			}});
		
		reiterate_droppables();
	}

	var IMPL_URLS = {};
	var IMPLS = {};

	// Return the 1st implementation of the given PE.
	// Assume there is at least one implementation associated with each PE.
	function retrieve_impl_urls(pe_urls) {
		var deferred = [];
		IMPL_URLS = {};
		for (var i = 0; i < pe_urls.length; i++) {
			var u = pe_urls[i];
			deferred.push(
				$.ajax({
					url: u,
					cache: false
				})
				.done(function(data){
					IMPL_URLS[data.url] = data.peimpls[0];
				})
				.fail(function(data){
					console.error('failure:' + data);
				})
			);
		}
		return deferred;
	}
	
	function retrieve_impls() {
		var deferred = [];
		IMPLS = {};
		$.each(IMPL_URLS, function(key, value) { 
			deferred.push(
				$.ajax({
					url: value,
					cache: false
				})
				.done(function(data) {
					IMPLS[key] = data.code;
				})
				.fail(function(data) {
					console.error('failure:' + data);
				})
			);
		});
		return deferred;
	}
	
	function extract_class_from_impl(impl_str) {
		if (impl_str == undefined) { 
			return null;
		}
		var lines = impl_str.split('\n');
		for (var i = 0; i < lines.length; i++) { 
			var curr_line = lines[i].trim();
			if (curr_line.slice(0, 5) == 'class') { 
				var par_index = curr_line.indexOf('(');
				var class_name = curr_line.slice(6, par_index).trim();
				return class_name;
			}
		}
		return null;
	}
	
	function extract_connections_from_impl(impl_str) { 
		var conns = {'in': [], 'out': []};
		if (impl_str == undefined) {
			return null;
		}
		var lines = impl_str.split('\n');
		for (var i = 0; i < lines.length; i++) { 
			var curr_line = lines[i].trim();
			if (curr_line.slice(0, 6) == ':input') {
				// + 1 is to compensate for substr(1)
				var indofseccol = curr_line.substr(1).indexOf(':') + 1;
				conns.in.push(curr_line.slice(7, indofseccol));
			} 
			else if (curr_line.slice(0, 7) == ':output') {
				// + 1 is to compensate for substr(1)
				var indofseccol = curr_line.substr(1).indexOf(':') + 1;
				conns.out.push(curr_line.slice(8, indofseccol));				
			}
		}
		return JSON.stringify(conns);
	}
	
	// XXX The following needs re-design / re-factoring
	function generate_code_action() { 
		// get unique PEs
		var uniq_pes = {};
		var abort = false; 

		$( '.square-box-filled' ).each(function(index) {

			if ( $( this ).hasClass('js-function') ) {
				// Abort - don't currently support mixed pipelines
				$( 'div#error-message' ).html("The generation of Python code is not currently supported for mixed pipelines. Please make sure your pipeline consists only of PEs.").dialog("open");
				abort = true;
				return;
			}

			var url = $(this).attr('data-peurl');
			var fqn = $(this).attr('data-pefqn');
			uniq_pes[url] = fqn;
		});

		if ( abort ) { return; }
		
		// extract implementation URLs from PE specs:
		var deferred = retrieve_impl_urls(Object.keys(uniq_pes));
		$.when.apply($, deferred).done(function() {			
			// extract the actual implementations based on IMPL_URLS: 
			var deferred2 = retrieve_impls();
			$.when.apply($, deferred2).done(function() {
				
				var imps = {};
				var inits = [];
				var connects = [];
				var prev_box = null;
				var prev_var = null;
				var abort_code = false;
				var errors = ''
				
				$('.square-box-filled').each(function(index) {
					var box = this;
					var url = $(this).attr('data-peurl');
					$.each(IMPLS, function(key, value) {
						if (url.trim() == key.trim()) {
							$(box).attr('data-peimpl', value);
							$(box).attr('data-peimpl-class', extract_class_from_impl(value));
							$(box).attr('data-connections', extract_connections_from_impl(value));
						}
					});
					
					// deal with the code
					imps['from ' + $(box).attr('data-pefqn') + ' import ' + $(box).attr('data-peimpl-class')] = true;
					
					if (! $(box).attr('data-peimpl-class')) {
						errors += $(box).attr('data-pefqn') + ' does not have an implementation.\n';
						abort_code = true;
						return;
					}
					var curr_var = $(box).attr('data-peimpl-class').toLowerCase() + '_' + index;
					
					inits.push(curr_var + ' = ' + $(box).attr('data-peimpl-class') + '()');
					if (prev_box != null) { 
						connects.push('graph.connect(' + prev_var + ', \'' + JSON.parse($(prev_box).attr('data-connections')).out[0] + '\', ' + curr_var + ', \'' + JSON.parse($(prev_box).attr('data-connections')).in[0] + '\')')
					}
					
					// keep pointers for next loop
					prev_box = box;
					prev_var = curr_var;
				});
				
				// generate the code
				if (inits.length == 0) { 
					errors += 'Please add a PE to the workflow first.\n';
				}
				if (abort_code || inits.length == 0)  {
					$( 'div#error-message' ).html(errors).dialog("open");
					return;
				}	
				var code = 'from dispel4py.workflow_graph import WorkflowGraph\nimport dispel4py.registry.registry as r\n';
				for (var imp in imps) { 
					code += imp + '\n';
				}
				code += '\n';
				
				for (var i = 0; i < inits.length; i++) { 
					code += inits[i] + '\n'
				}
				
				code += '\n';
				code += 'graph = WorkflowGraph()'
				code += '\n';
				
				for (var i = 0; i < connects.length; i++) { 
					code += connects[i] + '\n'
				}
				code += '\n'
				
				$('#code').html($.parseHTML(code));
				$('#code').dialog();

				// selectText('code');
			});
		});
	}

	function generate_intermediate_code_action() {
		var filledBoxes = $( '.square-box-filled' ); 
		var code = {};

		// XXX General properties - here we should add the registry's URL and other 
		// properties too... 
		code["output_units"] = "velocity";
    	code["rotate_to_ZRT"] = true;
    	code["title"] = $( 'div#wf-title' ).text();
    	code["data_processing"] = [];

		for ( var i = 0; i < filledBoxes.length; i++ ) {
			var currBox = filledBoxes[i];
			if ( ! $( currBox ).hasClass( 'js-function' ) ) {
				$( "div#error-message" ).html("The generation of intermediate code is not currently supported for mixed pipelines. Please make sure your pipeline consists only of functions.").dialog( "open" );
				return;
			}
			if ( ! hasBeenInitialised( currBox ) ) { 
				$( "div#error-message" ).html("Please make sure you have set the parameters of all functions.").dialog( "open" );
				return;	
			}

			var obj = {};
			obj["type"] = $( currBox ).attr("data-fnfqn");
			obj["url"] = $( currBox ).attr("data-fnurl");
			obj["parameters"] = {};

			var params = JSON.parse( $( currBox ).attr( "data-properties" ) ).parameters;
			for ( var j = 0; j < params.length; j++ ) {
				var paramName = params[j][0];
				if ( paramName == "stream" ) {  // Ignore "stream" parameters
					continue; 
				}
				var paramValue = params[j][2];
				obj.parameters[paramName] = JSON.parse(paramValue);
			}
			code.data_processing.push(obj);
		}
		$( "#code" ).text( JSON.stringify(code, null, 4) );
		$( "#code" ).dialog();

		// selectText('code');
	}

	function updateTips( t ) {
		tips
			.text( t )
			.addClass( "ui-state-highlight" );
		setTimeout(function() {
			tips.removeClass( "ui-state-highlight", 1500 );
		}, 500 );
    }

    // XXX Not working great. CSS or other issues?
	function selectText(element) {
	    var doc = document
	        , text = doc.getElementById(element)
	        , range, selection
	    ;    
	    if (doc.body.createTextRange) {
	        range = document.body.createTextRange();
	        range.moveToElementText(text);
	        range.select();
	    } else if (window.getSelection) {
	        selection = window.getSelection();        
	        range = document.createRange();
	        range.selectNodeContents(text);
	        selection.removeAllRanges();
	        selection.addRange(range);
	    }
	}

	/**
	 * Update an element's parameters based on the values of the parameters dialog.
	 * @return {boolean} Whether all values are valid on the form?
	 */
	function init_fn_dialog() {
		var valid = true;

		var inputs = $('div#dialog-form').find('input');
		inputs.removeClass( "ui-state-error" );
		var src_id = $('div#dialog-form').attr('data-src-id');
		var src = $('div#' + src_id);
		var properties = JSON.parse( $( src ).attr( 'data-properties' ) );

		for ( var i = 0; i < inputs.length; i++ ) {
			var parName = $( inputs[i] ).attr( 'name' );
			var parVal = $( inputs[i] ).val();
			valid = valid && isJson( inputs[i], parVal );
			// XXX Refactor - parameters should be a dictionary by parameter name 
			// in order to avoid the inner loop...
			for ( var j = 0; j < properties.parameters.length; j++ ) { 
				var currp = properties.parameters[j];
				if ( currp[0] == parName ) {
					currp[2] = parVal;
					break;
				}
			}
			properties.parameters[parName] = parVal;
		}
		if (valid) {
			$(src).attr('data-properties', JSON.stringify(properties));

			$(src).removeClass('js-fn-uninitialised');
			$(src).removeClass('js-fn-initialised');
			if (! hasBeenInitialised(src)) {
				$(src).addClass('js-fn-uninitialised');
				$(src).find('.init-btn').removeClass('js-btn-initialised');
				$(src).find('.init-btn').addClass('js-btn-not-initialised');
			}
			else {
				$(src).addClass('js-fn-initialised');
				$(src).find('.init-btn').removeClass('js-btn-not-initialised');
				$(src).find('.init-btn').addClass('js-btn-initialised');
			}
			dialog.dialog( "close" );
		}
		return valid;
	}

	function changeTitle() {
		var newTitle = $( 'input#wf-title-in' ).val();
		$( 'div#wf-title' ).text( newTitle );
		titlog.dialog( 'close' );
	}

	function isJson(element, str) {
	    try {
	        JSON.parse(str);
	    } catch (e) {
	    	if ( element !== null ) {
		    	$( element ).addClass( "ui-state-error" );
		    	updateTips( "Invalid JSON expression" );
	    	}
	        return false;
	    }
	    return true;
	}

$(document).ready(function(){
	var $loading = $('#loading').hide();
	
	// Global variable: tips 
	tips = $( '.validateTips' );

	$( document ).tooltip({
		show: {effect: "fade", duration:20},
		fade: {effect: "fade", duration:20}
	});

	$( document )
	.ajaxStart(function () {
	    $loading.show();
	})
	.ajaxStop(function () {
		$loading.hide();
	});

	$( 'a#help_link' ).click( function(event) {
		event.preventDefault();
		$('#help').dialog();
	});

	$( 'a#generate_code' ).click( function(event) {
		event.preventDefault();
		generate_code_action();
	});

	$( 'a#generate_intermediate_code' ).click( function(event) {
		event.preventDefault();
		generate_intermediate_code_action();
	});

	$('#menu').html('<div style="text-align:center; font-weight:bold">Toolbox <hr/></div>');

	populate_toolbox();
	
	init_flow_divs();

	dialog = $( "#dialog-form" ).dialog({
      autoOpen: false,
      // height: 400,
      width: 350,
      modal: true,
      buttons: {
        "OK": function(event) {
        	init_fn_dialog();
        	// dialog.dialog( "close" );
        },
        Cancel: function() {
          	dialog.dialog( "close" );
        }
      },
      close: function() {
      	form[ 0 ].reset();
      	var allFields = $( 'input.ui-widget-content' );
        allFields.removeClass( "ui-state-error" );
      }
    });
 
 	// XXX Hitting ENTER won't accept the values and close the dialog
    form = dialog.find( "form" ).on( "submit", function( event ) {
      event.preventDefault();
      init_fn_dialog();
    });

    titlog = $( "#wf-title-div" ).dialog({
      autoOpen: false,
      height: 200,
      width: 350,
      modal: true,
      buttons: {
        "OK": changeTitle,
        Cancel: function() {
          	titlog.dialog( "close" );
        }
      },
      close: function() {
      }
    });
 
    formtitle = titlog.find( "form" ).on( "submit", function( event ) {
      event.preventDefault();
      changeTitle();
    });

    errorMessage = $( "#error-message" ).dialog({
      autoOpen: false,
      modal: true,
      buttons: {
        Ok: function() {
          $( this ).dialog( "close" );
        }
      }
    });

    $( 'div#wf-title' ).click( function(event) {
    	event.preventDefault();
    	$( 'input#wf-title-in' ).val( $( 'div#wf-title' ).html() );
    	$( 'input#wf-title-in' ).select();
    	titlog.dialog("open");
    });

});

</script>
  
{%endblock%}

{% block banner %}
	<div class="bannercontent">
		Welcome {{request.user.username}} - 
		<a href="{% url 'ui:logout' %}">Log out</a>
	</div>
{% endblock %}


{% block content %}
<div id="wf-title">Untitled</div>

<div id="error-message" title="Error"> </div>

<div id="wf-title-div" title="New name">
	<form>
	    <fieldset id="wf-title-fset">
	    	<!-- <label for="wf-title-in">New title</label> -->
		    <input type="text" name="wf-title-in" id="wf-title-in" value="" class="text ui-widget-content ui-corner-all" > </input>
		    <input type="submit" tabindex="-1" style="position:absolute; top:-1000px" />
	    </fieldset>
    </form>
</div>

<div id="dialog-form" title="Parameters">
  <div class="validateTips">Parameters:</div> 
  <form>
    <fieldset id="fieldset-params">
      <!-- Allow form submission with keyboard without duplicating the dialog button -->
      <input type="submit" tabindex="-1" style="position:absolute; top:-1000px" />
    </fieldset>
  </form>
</div>

<div id="help" title="Help" style="font-size:0.9em; font-family:'Arial'">
	<p>Drag and drop PEs from the toolbox on the left to form a simple workflow.</p>
	<p>Add and remove PEs to customise your workflow. </p>
	<p>Click on an element to view further details. </p>
	<p>Click on the <em>Generate Code</em> link below to have your dispel4py code generated based on your graph.</p>
</div>

<div id="errors" title="Error!" style="font-size:0.9em; font-family:'Arial'">
</div>

<div id="code" title="dispel4py Code" style="font-size:0.9em;">
</div>

<div id="properties">
	<div id="properties-title" style="background-color:#bbccdd; text-align:center;"></div>
	<div id="properties-description"></div>
	<div id="properties-connections">
		<div id="properties-connections-in"></div>
		<div id="properties-connections-out"></div>
	</div>
</div>


{% endblock %}

{% block actions %}
<a title="Generate intermediate JSON code corresponding to the designed pipeline. This currently requires that the pipeline consists only of functions." href="#" id="generate_intermediate_code">Generate Intermediate Code</a>
| 
<a title="Generate dispel4py Python code corresponding to the designed pipeline. This currently requires that the pipeline consists only of PEs." href="#" id="generate_code">Generate Python Code</a> 
| 
<a href="#" id="help_link">Help</a>
<div id="loading">
	<img src="{% static "ui/images/ajax-loading.gif" %}" style="height:20px; width:20px;"/>
</div>

{% endblock %}


{% block menu %}
{% endblock %}
